# 使用示例

本文档提供了不同场景下的详细使用示例。

## 场景 1: 宿舍多设备共享

**环境**：
- 宿舍有1台台式机、2台笔记本、1台手机
- 校园网限制：1台PC + 1台手机

**方案**：

1. **将台式机作为服务器**（24小时在线）：
```bash
python vpn_server.py MR646C80105795 mypassword 8888
```

2. **笔记本1使用GUI客户端**：
```bash
python vpn_client_gui.py
# 在GUI中填写信息并连接
```

3. **笔记本2使用命令行客户端**：
```bash
python vpn_client.py MR646C80105795 mypassword 172.21.77.34 8888
```

4. **手机使用Flet GUI**：
   - 在手机上安装Python和Flet
   - 运行GUI客户端

**结果**：所有设备都可以通过台式机共享网络。

---

## 场景 2: 树莓派做永久服务器

**环境**：
- 树莓派 4B（Raspberry Pi OS）
- 多台设备需要上网

**部署步骤**：

### 1. 在树莓派上安装依赖

```bash
# 更新系统
sudo apt update && sudo apt upgrade -y

# 安装Python和pip
sudo apt install python3 python3-pip -y

# 克隆项目
cd ~
git clone <项目地址>
cd drcom

# 安装依赖
pip3 install -r requirements.txt
```

### 2. 配置开机自启动

创建服务文件：
```bash
sudo nano /etc/systemd/system/drcom-vpn.service
```

内容：
```ini
[Unit]
Description=Dr.COM VPN Server
After=network.target

[Service]
Type=simple
User=pi
WorkingDirectory=/home/pi/drcom
ExecStart=/usr/bin/python3 /home/pi/drcom/vpn_server.py MR646C80105795 mypassword 8888
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
```

启用服务：
```bash
sudo systemctl enable drcom-vpn
sudo systemctl start drcom-vpn
```

查看状态：
```bash
sudo systemctl status drcom-vpn
```

### 3. 客户端连接

在其他设备上运行客户端，服务器IP使用树莓派的内网IP。

---

## 场景 3: OpenWrt 路由器作为客户端

**环境**：
- OpenWrt 路由器（支持Python）
- 服务器已在其他设备运行

**部署步骤**：

### 1. 在 OpenWrt 上安装 Python

```bash
opkg update
opkg install python3 python3-pip
```

### 2. 上传客户端文件

使用 SCP 上传必要文件：
```bash
scp config.py logger.py drcom_login.py vpn_client.py root@192.168.1.1:/root/drcom/
```

### 3. 安装依赖（精简版）

```bash
ssh root@192.168.1.1
cd /root/drcom
pip3 install requests
```

### 4. 运行客户端

```bash
python3 vpn_client.py MR646C80105795 mypassword 172.21.77.34 8888
```

### 5. 配置开机自启动

编辑 `/etc/rc.local`：
```bash
vi /etc/rc.local
```

添加：
```bash
cd /root/drcom
python3 vpn_client.py MR646C80105795 mypassword 172.21.77.34 8888 &
exit 0
```

---

## 场景 4: Docker 部署（推荐）

**环境**：
- 任何支持Docker的设备
- 需要稳定的网络服务

**服务端 Dockerfile**：

创建 `Dockerfile`：
```dockerfile
FROM python:3.9-slim

WORKDIR /app

# 安装依赖
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# 复制项目文件
COPY . .

# 创建日志目录
RUN mkdir -p logs

# 暴露端口
EXPOSE 8888

# 启动命令（通过环境变量传递参数）
CMD ["sh", "-c", "python vpn_server.py $USERNAME $PASSWORD $PORT"]
```

**构建和运行**：
```bash
# 构建镜像
docker build -t drcom-vpn-server .

# 运行容器
docker run -d \
  --name vpn-server \
  --network host \
  -e USERNAME=MR646C80105795 \
  -e PASSWORD=mypassword \
  -e PORT=8888 \
  -v $(pwd)/logs:/app/logs \
  --restart unless-stopped \
  drcom-vpn-server

# 查看日志
docker logs -f vpn-server
```

**客户端容器**：
```bash
docker run -d \
  --name vpn-client \
  --network host \
  -e USERNAME=MR646C80105795 \
  -e PASSWORD=mypassword \
  -e SERVER_IP=172.21.77.34 \
  -e SERVER_PORT=8888 \
  -v $(pwd)/logs:/app/logs \
  --restart unless-stopped \
  drcom-vpn-client
```

---

## 场景 5: 多服务器负载均衡

**环境**：
- 有3台可用设备做服务器
- 大量客户端需要连接

**方案**：

### 1. 部署多个服务器

服务器1（端口8888）：
```bash
python vpn_server.py user1 pass1 8888
```

服务器2（端口8889）：
```bash
python vpn_server.py user2 pass2 8889
```

服务器3（端口8890）：
```bash
python vpn_server.py user3 pass3 8890
```

### 2. 客户端轮流连接

客户端1连接服务器1：
```bash
python vpn_client.py user1 pass1 172.21.77.11 8888
```

客户端2连接服务器2：
```bash
python vpn_client.py user2 pass2 172.21.77.12 8889
```

客户端3连接服务器3：
```bash
python vpn_client.py user3 pass3 172.21.77.13 8890
```

---

## 场景 6: 测试和调试

**测试网络连通性**：

```bash
# 测试能否访问外网
ping www.bing.com

# 测试能否访问服务器内网
ping 172.21.77.34

# 测试服务器端口是否开放
telnet 172.21.77.34 8888
# 或
nc -zv 172.21.77.34 8888
```

**查看详细日志**：

```bash
# 实时查看服务器日志
tail -f logs/vpn_server_20250101.log

# 搜索错误信息
grep ERROR logs/vpn_server_20250101.log

# 查看最近100行日志
tail -n 100 logs/vpn_client_20250101.log
```

**测试登录功能**：

```bash
# 单独测试登录模块
python drcom_login.py MR646C80105795 mypassword
```

---

## 场景 7: 移动场景（笔记本）

**环境**：
- 笔记本需要在不同地点使用
- 服务器固定在宿舍

**使用方法**：

1. **在宿舍**：笔记本可以直接登录使用

2. **在图书馆**：
   - 确保图书馆网络和宿舍在同一校园网
   - 使用VPN客户端连接到宿舍服务器
   ```bash
   python vpn_client_gui.py
   # 填写宿舍服务器的IP
   ```

3. **在教室**：同图书馆

**注意**：不同校区可能网络隔离，需要测试内网互通性。

---

## 场景 8: 多账号管理

**环境**：
- 有多个Dr.COM账号
- 需要灵活切换

**创建配置文件**：

`accounts.txt`：
```
account1:password1
account2:password2
account3:password3
```

**创建启动脚本** `start_server.sh`：
```bash
#!/bin/bash

# 读取账号信息
ACCOUNT=$(head -n 1 accounts.txt | cut -d: -f1)
PASSWORD=$(head -n 1 accounts.txt | cut -d: -f2)

# 启动服务器
python vpn_server.py $ACCOUNT $PASSWORD 8888
```

**轮换账号**：
```bash
# 将第一行移到最后
tail -n +2 accounts.txt > accounts.tmp && \
head -n 1 accounts.txt >> accounts.tmp && \
mv accounts.tmp accounts.txt
```

---

## 场景 9: 异常恢复

**服务器意外断线**：

服务器会自动重试登录（最多5次），查看日志：
```bash
tail -f logs/vpn_server_*.log
```

**客户端连接失败**：

客户端会自动重试连接（最多10次），等待服务器恢复。

**手动重启**：
```bash
# 停止服务（Ctrl+C）
# 重新启动
python vpn_server.py username password 8888
```

---

## 场景 10: 性能优化

**提高连接速度**：

编辑 `config.py`：
```python
RETRY_CONFIG = {
    'max_retries': 3,        # 减少重试次数
    'retry_delay': 10,       # 减少重试延迟
    'ping_timeout': 3,       # 减少ping超时
}

VPN_CONFIG = {
    'buffer_size': 16384,    # 增大缓冲区
    'heartbeat_interval': 60,  # 增大心跳间隔
}
```

**降低日志级别**（生产环境）：
```python
LOG_CONFIG = {
    'log_level': 'INFO',     # 改为INFO或WARNING
}
```

---

## 故障排查流程图

```
开始
  ↓
能否ping通外网？
  ├─ 是 → 网络正常，无需VPN
  └─ 否 ↓
能否ping通服务器内网IP？
  ├─ 是 → 内网正常
  │       ↓
  │     服务器端口开放吗？
  │       ├─ 是 → 检查客户端配置
  │       └─ 否 → 重启服务器
  └─ 否 → 检查网络连接
          ↓
        查看详细日志
```

---

**更多问题？** 查看 README.md 或提交 Issue。

