# Dr.COM 校园网认证系统验证逻辑分析

## 网站概述
- **URL**: http://10.252.252.5/
- **系统**: Dr.COM 校园网认证系统
- **学校**: 南宁理工学院
- **当前状态**: 已登录状态（注销页面）

## 1. 核心认证参数

从页面内联脚本中提取的关键参数：

### 用户信息
```javascript
uid='MR646C80105795'          // 当前登录用户账号
pwd=''                          // 密码（已清空）
v4ip='172.21.77.34'            // 用户IPv4地址
lip='172.21.77.34'             // 本地IP地址
time='41467'                    // 在线时长
flow='1532264202'              // 流量使用（字节）
stime='2025-11-01 00:00:03'    // 登录开始时间
etime='2025-11-06 20:57:32'    // 当前时间
```

### 认证服务器配置
```javascript
authloginIP=''                           // 登录IP
authloginport=801                        // 登录端口
authloginpath='/eportal/?c=ACSetting&a=Login'  // 登录路径
authloginparam='url=drappall'            // 登录参数
authuserfield='DDDDD'                    // 账号字段名
authpassfield='upass'                    // 密码字段名

authlogoutpath='/eportal/?c=ACSetting&a=Logout&ver=1.0'  // 注销路径
authlogoutparam='url=drappall'           // 注销参数
```

## 2. 认证流程

### 2.1 登录验证流程

根据 `a41.js` 的代码分析，认证流程如下：

#### 步骤1: 初始化终端参数
```javascript
term.init() {
    // 获取终端类型（PC/手机/平板）
    this.type = util.getTermType();
    
    // 从URL参数或内核变量获取IP
    this.ip = util.getQueryString('ip', 'wlanuserip', 'userip'...);
    
    // 获取MAC地址
    this.mac = util.getQueryString('mac', 'usermac'...).replace(/[\-\:]/g, '');
    
    // 获取其他参数：VLAN、SSID、ACIP等
}
```

#### 步骤2: 获取页面配置
```javascript
getPageInfo() {
    // 请求: portal_api + 'page/loadConfig'
    // 参数:
    - program_index
    - wlan_vlan_id
    - wlan_user_ip (Base64编码)
    - wlan_user_ipv6 (Base64编码)
    - wlan_user_mac
    - wlan_ac_ip
    - wlan_ap_mac
    - gw_id
}
```

#### 步骤3: 检查用户状态
```javascript
checkStatus() {
    // 方式1: 内核接口
    url = '/drcom/chkstatus'
    
    // 方式2: Radius接口 (checkOnlineMethod==1)
    url = portal_api + 'online_list'
    data = {
        'user_account': '',
        'user_password': '',
        'wlan_user_mac': MAC地址(大写),
        'wlan_user_ip': IP转十进制,
        'curr_user_ip': IP转十进制
    }
    
    // 返回结果:
    // result=0: 已在线
    // result=1: 离线
}
```

#### 步骤4: 感知认证（如启用）
```javascript
checkMac() {
    url = portal_api + 'perceive'
    data = {
        login_method,
        wlan_user_ip,
        wlan_user_ipv6,
        wlan_vlan_id,
        wlan_user_mac,
        wlan_ac_ip,
        wlan_ac_name,
        data_format: 0/2,  // 0-检查感知状态 2-感知认证登录
        suffix,
        ssid
    }
    
    // 返回结果:
    // result=1: 已在线或感知认证成功
    // result=10: 显示快捷登录页
}
```

### 2.2 认证方式

系统支持多种认证方式（通过 `login_method` 区分）：

1. **普通Portal认证** (默认)
2. **旁路认证** (`authexenable='0'`)
3. **WifiDog认证** (`login_method=14`)
4. **Eduroam认证** (特殊流程)
5. **感知认证** (自动MAC认证)

### 2.3 运营商选择

系统支持多种服务类型：

```javascript
carrier = {
    "yys": {
        "title": "服务类型",
        "mode": "radiobutton",
        "type": "0",
        "data": [
            {"id":"1", "name":"校园用户", "suffix":""},
            {"id":"2", "name":"校园电信", "suffix":"@dx"},
            {"id":"3", "name":"校园联通", "suffix":"@lt"},
            {"id":"4", "name":"校园其他", "suffix":""}
        ],
        "defaultID": "1"
    }
}
```

## 3. API接口

### 3.1 主要接口地址

基础URL: `http://10.252.252.5:801/eportal/`

| 接口路径 | 用途 | 方法 |
|---------|------|------|
| `/portal/page/loadConfig` | 加载页面配置 | JSONP |
| `/portal/online_list` | 查询在线状态 | JSONP |
| `/portal/perceive` | 感知认证 | JSONP |
| `/portal/visitor/checkUserStateByIP` | 检查用户状态 | JSONP |
| `/?c=ACSetting&a=Login` | 用户登录 | POST |
| `/?c=ACSetting&a=Logout&ver=1.0` | 用户注销 | GET/POST |
| `/drcom/chkstatus` | 内核状态查询 | JSONP |

### 3.2 请求示例

**状态查询请求** (已观察到):
```
GET http://10.252.252.5:801/eportal/portal/page/loadConfig?
    callback=dr1001
    &program_index=
    &wlan_vlan_id=1
    &wlan_user_ip=MTcyLjIxLjc3LjM0  (Base64编码的IP)
    &wlan_user_ipv6=
    &wlan_user_ssid=
    &wlan_user_areaid=
    &wlan_ac_ip=
    &wlan_ap_mac=000000000000
    &gw_id=000000000000
    &jsVersion=4.X
    &v=583
    &lang=zh
```

## 4. 关键安全机制

### 4.1 密码处理
- 支持MD5加密传输 (`en_md5=0`)
- 可配置密码截取 (`password_cut=0`)
- 密码模式 (`pwm=1`)

### 4.2 MAC绑定
- 支持MAC地址绑定认证
- 注销时可解绑MAC (`unBindMac=0/1`)
- MAC获取方式：Radius或全业务接口

### 4.3 IPv6支持
```javascript
v6af=0           // IPv6认证标志
v6df=0           // IPv6数据标志
enablev6=0       // IPv4/IPv6模式
```

### 4.4 会话管理
- Session格式: `ss3-ss4-ss2` (IP-MAC-时间戳)
- 在线时长限制: `oltime=4294967295`
- 流量限制: `olflow=4294967295`

## 5. 页面资源结构

### 5.1 核心JavaScript文件

| 文件 | 功能 |
|------|------|
| `a41.js` | 核心配置和页面初始化 |
| `a40.js` | 压缩后的公共功能JS |
| `a42.js` | 国际化加载 |
| `a43.js` | 核心业务逻辑 |
| `a44.js` | 旁路认证 |
| `a45.js` | 短信认证 |
| `a47.js` | 二维码扫码功能 |
| `a48.js` | 钉钉认证功能 |
| `a49.js` | 自助服务 |
| `a50.js` | 广告统计功能 |
| `a51.js` | 商教功能 |
| `a52.js` | 企业微信功能 |

### 5.2 外部依赖

- jQuery (包含在all.js)
- Layer.js (弹层组件)
- FlexSlider (轮播图)
- store.js (本地存储)
- jquery.i18n.js (国际化)

## 6. 客户端特性检测

```javascript
util.getTermType() {
    // 终端类型识别:
    // 0-其他
    // 1-PC
    // 2-手机
    // 3-平板(横屏)
    // 4-平板(竖屏)
    
    // 根据User-Agent判断:
    // - Android
    // - BlackBerry
    // - iOS (iPhone/iPad)
    // - Windows/Windows Phone
    // - 等等
}
```

## 7. 重定向机制

```javascript
ISRedirect = 0                  // 是否重定向
redirectLink = ''               // 登录重定向地址
rebackLink = ''                 // 注销重定向地址
redirectLogout = 0              // 强制跳转注销页
```

## 8. 扩展功能

### 8.1 第三方登录
- 钉钉扫码登录
- 企业微信登录
- 微信公众号登录

### 8.2 自助服务
- 账号注册 (根据 `registerMode`)
- 密码修改 (根据 `changePassMode`)
- 在线充值

### 8.3 多语言支持
- 中文 (默认, gb2312编码)
- 英文 (通过store.get("i18n_lang"))

## 9. 注销流程

从当前页面可以看到注销按钮：

```html
<input name="logout" 
       onclick="javascript:wc()" 
       type="button" 
       value="注 销">
```

注销函数 `wc()` 会调用：
```
GET/POST http://10.252.252.5:801/eportal/?c=ACSetting&a=Logout&ver=1.0&url=drappall
```

## 10. 特点总结

1. **灵活的认证方式**: 支持Portal、旁路、感知等多种认证
2. **完善的终端检测**: 自动识别PC/手机/平板，响应式页面
3. **运营商分离**: 支持校园、电信、联通等多种账号后缀
4. **安全机制**: MAC绑定、密码加密、会话管理
5. **可扩展性**: 支持第三方登录、广告系统、自助服务
6. **国际化**: 支持中英文切换
7. **多平台适配**: 内核接口 + Radius接口双模式

## 11. 注意事项

1. 页面编码使用 GB2312，需注意中文处理
2. 大部分接口使用JSONP跨域请求
3. IP地址可能需要Base64编码或转十进制
4. MAC地址需要去除分隔符并转大写
5. 支持别名认证 (`enable_alias=0`)
6. 缓存过期时间可配置 (`storeExpireTime=86400秒`)

---

**分析时间**: 2025-11-06  
**系统版本**: Dr.COM Portal 4.0  
**JS版本**: 4.X

