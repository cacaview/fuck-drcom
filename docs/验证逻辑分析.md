# Dr.COM 校园网认证系统验证逻辑分析

## 网站概述
- **URL**: http://10.252.252.5/
- **系统**: Dr.COM 校园网认证系统
- **学校**: 南宁理工学院
- **当前状态**: 已登录状态（注销页面）

## 1. 核心认证参数

从页面内联脚本中提取的关键参数：

### 用户信息
```javascript
uid='MR646C80105795'          // 当前登录用户账号
pwd=''                          // 密码（已清空）
v4ip='172.21.77.34'            // 用户IPv4地址（网线）
v4ip='172.19.214.2'            // 用户IPv4地址（WiFi）
lip='172.21.77.34'             // 本地IP地址
time='41467'                    // 在线时长
flow='1532264202'              // 流量使用（字节）
stime='2025-11-01 00:00:03'    // 登录开始时间
etime='2025-11-06 20:57:32'    // 当前时间
```

### WiFi特有参数（关键！）
```javascript
AC=""                           // AC名称（WiFi环境下通常为空，需从URL获取）
ss4="000000000000"             // MAC地址（网线为全0，WiFi需真实MAC）
wlanacip=""                     // 无线控制器IP（网线为空，WiFi必需）
wlanacname=""                   // AC名称（网线为空，WiFi必需）
ssid=""                         // WiFi的SSID（网线为空）
```

### 认证服务器配置
```javascript
authloginIP=''                           // 登录IP
authloginport=801                        // 登录端口
authloginpath='/eportal/?c=ACSetting&a=Login'  // 登录路径
authloginparam='url=drappall'            // 登录参数
authuserfield='DDDDD'                    // 账号字段名
authpassfield='upass'                    // 密码字段名

authlogoutpath='/eportal/?c=ACSetting&a=Logout&ver=1.0'  // 注销路径
authlogoutparam='url=drappall'           // 注销参数
```

## 2. 认证流程

### 2.1 WiFi vs 网线连接区别

#### 网线连接特点：
- 直接访问认证页面 `http://10.252.252.5/`
- 页面中 `AC=""`，`ss4="000000000000"`
- URL中**没有** WiFi参数（usermac、wlanacip等）
- 登录请求使用默认值：
  - `wlan_user_mac=000000000000`
  - `wlan_ac_ip=""`
  - `wlan_ac_name=""`

#### WiFi连接特点（关键！）：
1. **AC重定向机制**：
   - 用户访问外网（如 www.baidu.com）
   - 无线控制器（AC）拦截请求
   - 重定向到认证页面，URL包含WiFi参数：
   ```
   http://10.252.252.5/a79.htm?
       wlanuserip=172.19.214.2
       &usermac=d4-84-09-df-3b-04       ← 真实MAC地址！
       &wlanacip=10.20.10.4              ← AC IP地址！
       &wlanacname=1234001010000460      ← AC名称！
       &ssid=NNLGXY                       ← WiFi SSID！
   ```

2. **WiFi认证必需参数**：
   - `wlan_user_mac`: WiFi网卡的真实MAC地址
   - `wlan_ac_ip`: 无线控制器(AC)的IP地址
   - `wlan_ac_name`: AC设备名称/编号
   - `ssid`: WiFi的SSID名称（可选但建议提供）

3. **参数获取流程**：
   ```javascript
   // 网页JavaScript通过以下方式获取WiFi参数：
   term.init() {
       // 优先从URL参数获取（AC重定向后的URL）
       this.mac = util.getQueryString('usermac', 'mac'...) || ss4;
       this.wlanacip = util.getQueryString('wlanacip', 'acip'...) || '';
       this.wlanacname = util.getQueryString('wlanacname'...) || '';
       this.ssid = util.getQueryString('ssid', 'essid') || '';
   }
   ```

### 2.2 登录验证流程

根据 `a41.js` 的代码分析，认证流程如下：

#### 步骤1: 初始化终端参数
```javascript
term.init() {
    // 获取终端类型（PC/手机/平板）
    this.type = util.getTermType();
    
    // 从URL参数或内核变量获取IP
    this.ip = util.getQueryString('ip', 'wlanuserip', 'userip'...)
             || v46ip || ss5 || v4ip || util.hex16ToString(ss3);
    
    // 【关键】获取MAC地址（优先级顺序）
    this.mac = util.getQueryString('mac', 'usermac', 'wlanusermac'...)  // URL参数
             || ss4                                                      // 页面变量
             || '000000000000';                                         // 默认值
    
    // 【WiFi必需】获取AC信息（仅从URL参数）
    this.wlanacip = util.getQueryString('wlanacip', 'acip'...) || '';
    this.wlanacname = util.getQueryString('wlanacname'...) || '';
    this.ssid = util.getQueryString('ssid', 'essid') || '';
    
    // 其他参数：VLAN、Session等
    this.vlan = util.getQueryString('vlan', 'vlanid') || vlanid || 1;
}
```

**关键差异：**
- **网线**：直接访问认证页面，URL中无WiFi参数，MAC使用默认值 `000000000000`
- **WiFi**：通过AC重定向访问，URL中包含完整WiFi参数（MAC、AC IP、AC名称、SSID）

#### 步骤2: 获取页面配置
```javascript
getPageInfo() {
    // 请求: portal_api + 'page/loadConfig'
    // 参数:
    data = {
        program_index: page.name,
        wlan_vlan_id: term.vlan,
        wlan_user_ip: util.base64encode(term.ip),      // IP需Base64编码
        wlan_user_ipv6: util.base64encode(term.ipv6),
        wlan_user_ssid: term.ssid,                     // WiFi SSID
        wlan_user_areaid: term.areaID,
        wlan_ac_ip: util.base64encode(term.wlanacip),  // AC IP需Base64编码
        wlan_ap_mac: term.wlanapmac,
        gw_id: term.gw_id
    }
    
    // 网线示例:
    // wlan_user_ip=MTcyLjIxLjc3LjM0 (Base64: 172.21.77.34)
    // wlan_ac_ip= (空)
    // wlan_user_ssid= (空)
    
    // WiFi示例:
    // wlan_user_ip=MTcyLjE5LjIxNC4y (Base64: 172.19.214.2)
    // wlan_ac_ip=MTAuMjAuMTAuNA== (Base64: 10.20.10.4)
    // wlan_user_ssid=NNLGXY
}
```

#### 步骤3: 检查用户状态
```javascript
checkStatus() {
    // 方式1: 内核接口
    url = '/drcom/chkstatus'
    
    // 方式2: Radius接口 (checkOnlineMethod==1)
    url = portal_api + 'online_list'
    data = {
        'user_account': '',
        'user_password': '',
        'wlan_user_mac': MAC地址(大写),
        'wlan_user_ip': IP转十进制,
        'curr_user_ip': IP转十进制
    }
    
    // 返回结果:
    // result=0: 已在线
    // result=1: 离线
}
```

#### 步骤4: 感知认证（如启用）
```javascript
checkMac() {
    url = portal_api + 'perceive'
    data = {
        login_method,
        wlan_user_ip,
        wlan_user_ipv6,
        wlan_vlan_id,
        wlan_user_mac,
        wlan_ac_ip,
        wlan_ac_name,
        data_format: 0/2,  // 0-检查感知状态 2-感知认证登录
        suffix,
        ssid
    }
    
    // 返回结果:
    // result=1: 已在线或感知认证成功
    // result=10: 显示快捷登录页
}
```

### 2.2 认证方式

系统支持多种认证方式（通过 `login_method` 区分）：

1. **普通Portal认证** (默认)
2. **旁路认证** (`authexenable='0'`)
3. **WifiDog认证** (`login_method=14`)
4. **Eduroam认证** (特殊流程)
5. **感知认证** (自动MAC认证)

### 2.3 运营商选择

系统支持多种服务类型：

```javascript
carrier = {
    "yys": {
        "title": "服务类型",
        "mode": "radiobutton",
        "type": "0",
        "data": [
            {"id":"1", "name":"校园用户", "suffix":""},
            {"id":"2", "name":"校园电信", "suffix":"@dx"},
            {"id":"3", "name":"校园联通", "suffix":"@lt"},
            {"id":"4", "name":"校园其他", "suffix":""}
        ],
        "defaultID": "1"
    }
}
```

## 3. API接口

### 3.1 主要接口地址

基础URL: `http://10.252.252.5:801/eportal/`

| 接口路径 | 用途 | 方法 |
|---------|------|------|
| `/portal/page/loadConfig` | 加载页面配置 | JSONP |
| `/portal/online_list` | 查询在线状态 | JSONP |
| `/portal/perceive` | 感知认证 | JSONP |
| `/portal/visitor/checkUserStateByIP` | 检查用户状态 | JSONP |
| `/?c=ACSetting&a=Login` | 用户登录 | POST |
| `/?c=ACSetting&a=Logout&ver=1.0` | 用户注销 | GET/POST |
| `/drcom/chkstatus` | 内核状态查询 | JSONP |

### 3.2 请求示例

**网线连接 - 状态查询请求**:
```
GET http://10.252.252.5:801/eportal/portal/page/loadConfig?
    callback=dr1001
    &program_index=
    &wlan_vlan_id=0
    &wlan_user_ip=MTcyLjIxLjc3LjM0  (Base64编码: 172.21.77.34)
    &wlan_user_ipv6=
    &wlan_user_ssid=              ← 空（网线无SSID）
    &wlan_user_areaid=
    &wlan_ac_ip=                  ← 空（网线无AC）
    &wlan_ap_mac=000000000000
    &gw_id=000000000000
    &jsVersion=4.X
```

**WiFi连接 - 状态查询请求**:
```
GET http://10.252.252.5:801/eportal/portal/page/loadConfig?
    callback=dr1001
    &program_index=
    &wlan_vlan_id=0
    &wlan_user_ip=MTcyLjE5LjIxNC4y        (Base64编码: 172.19.214.2)
    &wlan_user_ipv6=
    &wlan_user_ssid=NNLGXY                ← WiFi的SSID
    &wlan_user_areaid=
    &wlan_ac_ip=MTAuMjAuMTAuNA==          ← Base64编码: 10.20.10.4
    &wlan_ap_mac=000000000000
    &gw_id=000000000000
    &jsVersion=4.X
```

**网线连接 - 登录请求**:
```
GET http://10.252.252.5:801/eportal/portal/login?
    callback=dr1003
    &login_method=1
    &user_account=,0,23410338@telecom
    &user_password=Bw093019
    &wlan_user_ip=172.21.77.34
    &wlan_user_ipv6=
    &wlan_user_mac=000000000000          ← 全0的MAC
    &wlan_ac_ip=                          ← 空
    &wlan_ac_name=                        ← 空
    &jsVersion=4.2.1
    &terminal_type=1
    &lang=zh-cn

响应: dr1003({"result":1,"msg":"Portal协议认证成功！"})  ✅ 成功
```

**WiFi连接 - 登录请求（第一次，无WiFi参数）**:
```
GET http://10.252.252.5:801/eportal/portal/login?
    (参数同网线连接)
    &wlan_user_mac=000000000000          ← 全0
    &wlan_ac_ip=                          ← 空
    &wlan_ac_name=                        ← 空

响应: dr1003({"result":0,"msg":"AC认证失败，请关闭代理...","ret_code":4})  ❌ 失败
```

**WiFi连接 - 登录请求（第二次，有WiFi参数）**:
```
GET http://10.252.252.5:801/eportal/portal/login?
    (其他参数同上)
    &wlan_user_mac=d48409df3b04         ← 真实MAC地址！
    &wlan_ac_ip=10.20.10.4               ← AC IP！
    &wlan_ac_name=1234001010000460       ← AC名称！
    &jsVersion=4.2.1
    &terminal_type=1

响应: dr1003({"result":1,"msg":"Portal协议认证成功！"})  ✅ 成功
```

## 4. 关键安全机制

### 4.1 密码处理
- 支持MD5加密传输 (`en_md5=0`)
- 可配置密码截取 (`password_cut=0`)
- 密码模式 (`pwm=1`)

### 4.2 MAC绑定
- 支持MAC地址绑定认证
- 注销时可解绑MAC (`unBindMac=0/1`)
- MAC获取方式：Radius或全业务接口

### 4.3 IPv6支持
```javascript
v6af=0           // IPv6认证标志
v6df=0           // IPv6数据标志
enablev6=0       // IPv4/IPv6模式
```

### 4.4 会话管理
- Session格式: `ss3-ss4-ss2` (IP-MAC-时间戳)
- 在线时长限制: `oltime=4294967295`
- 流量限制: `olflow=4294967295`

## 5. 页面资源结构

### 5.1 核心JavaScript文件

| 文件 | 功能 |
|------|------|
| `a41.js` | 核心配置和页面初始化 |
| `a40.js` | 压缩后的公共功能JS |
| `a42.js` | 国际化加载 |
| `a43.js` | 核心业务逻辑 |
| `a44.js` | 旁路认证 |
| `a45.js` | 短信认证 |
| `a47.js` | 二维码扫码功能 |
| `a48.js` | 钉钉认证功能 |
| `a49.js` | 自助服务 |
| `a50.js` | 广告统计功能 |
| `a51.js` | 商教功能 |
| `a52.js` | 企业微信功能 |

### 5.2 外部依赖

- jQuery (包含在all.js)
- Layer.js (弹层组件)
- FlexSlider (轮播图)
- store.js (本地存储)
- jquery.i18n.js (国际化)

## 6. 客户端特性检测

```javascript
util.getTermType() {
    // 终端类型识别:
    // 0-其他
    // 1-PC
    // 2-手机
    // 3-平板(横屏)
    // 4-平板(竖屏)
    
    // 根据User-Agent判断:
    // - Android
    // - BlackBerry
    // - iOS (iPhone/iPad)
    // - Windows/Windows Phone
    // - 等等
}
```

## 7. 重定向机制

```javascript
ISRedirect = 0                  // 是否重定向
redirectLink = ''               // 登录重定向地址
rebackLink = ''                 // 注销重定向地址
redirectLogout = 0              // 强制跳转注销页
```

## 8. 扩展功能

### 8.1 第三方登录
- 钉钉扫码登录
- 企业微信登录
- 微信公众号登录

### 8.2 自助服务
- 账号注册 (根据 `registerMode`)
- 密码修改 (根据 `changePassMode`)
- 在线充值

### 8.3 多语言支持
- 中文 (默认, gb2312编码)
- 英文 (通过store.get("i18n_lang"))

## 9. 注销流程

从当前页面可以看到注销按钮：

```html
<input name="logout" 
       onclick="javascript:wc()" 
       type="button" 
       value="注 销">
```

注销函数 `wc()` 会调用：
```
GET/POST http://10.252.252.5:801/eportal/?c=ACSetting&a=Logout&ver=1.0&url=drappall
```

## 10. 特点总结

1. **灵活的认证方式**: 支持Portal、旁路、感知等多种认证
2. **完善的终端检测**: 自动识别PC/手机/平板，响应式页面
3. **运营商分离**: 支持校园、电信、联通等多种账号后缀
4. **安全机制**: MAC绑定、密码加密、会话管理
5. **可扩展性**: 支持第三方登录、广告系统、自助服务
6. **国际化**: 支持中英文切换
7. **多平台适配**: 内核接口 + Radius接口双模式

## 11. WiFi环境认证关键要点

### 11.1 AC重定向机制

在WiFi环境下，认证流程与网线完全不同：

1. **用户行为**：用户连接WiFi后访问任意外网网址（如 www.baidu.com）
2. **AC拦截**：无线控制器（AC）拦截未认证设备的流量
3. **重定向**：AC将请求重定向到认证页面，URL携带WiFi参数：
   ```
   http://10.252.252.5/a79.htm?
       wlanuserip=172.19.214.2
       &usermac=d4-84-09-df-3b-04          ← 真实MAC
       &uservid=1154
       &wlanacip=10.20.10.4                 ← AC IP
       &wlanacname=1234001010000460         ← AC名称
       &wlanacname=Ruijie_Ac_435497         ← AC别名（可能有多个）
       &url=http%3A%2F%2Fwww.baidu.com%2F  ← 原始访问的URL
       &ssid=NNLGXY                         ← WiFi SSID
       &nasport=1
       &userid=2886981122
   ```

4. **参数提取**：网页JavaScript从URL中提取这些参数用于后续认证

### 11.2 Python实现WiFi认证的关键步骤

```python
# 1. 触发AC重定向（不自动跟随）
response = session.get(
    'http://www.baidu.com',
    allow_redirects=False,  # 关键！手动处理重定向
    timeout=5
)

# 2. 检查是否有重定向
if response.status_code in [301, 302, 303, 307, 308]:
    redirect_url = response.headers.get('Location', '')
    # redirect_url 即包含WiFi参数的完整URL

# 3. 从重定向URL提取参数
import re
mac = re.search(r'usermac=([0-9a-fA-F\-:]+)', redirect_url)
ac_ip = re.search(r'wlanacip=(\d+\.\d+\.\d+\.\d+)', redirect_url)
ac_name = re.search(r'wlanacname=([^&]+)', redirect_url)
ssid = re.search(r'ssid=([^&]+)', redirect_url)

# 4. 使用这些参数登录
params = {
    'wlan_user_mac': mac.group(1).replace('-', '').replace(':', ''),
    'wlan_ac_ip': ac_ip.group(1),
    'wlan_ac_name': ac_name.group(1),
    # ... 其他参数
}
```

### 11.3 特殊环境处理

**双网卡 + 特定路由环境**：
```bash
# 如果设置了特定路由，访问外网不会触发AC重定向
route ADD 10.252.252.5 MASK 255.255.255.255 172.19.215.254 -p

# 解决方案：
# 1. 临时删除路由，获取WiFi参数
route DELETE 10.252.252.5

# 2. 获取参数后再添加回路由
route ADD 10.252.252.5 MASK 255.255.255.255 172.19.215.254 -p
```

### 11.4 在线状态验证

**重要发现：** Portal认证成功（`result:1`）≠ 真正在线！

```javascript
// chkstatus 接口返回值
{
    "result": 0,  // 0=离线, 1=在线
    "v46ip": "172.19.214.2",
    "AC": "",
    "ss4": "000000000000",  // MAC地址（可能为全0）
    ...
}
```

**验证流程：**
1. Portal API返回 `result:1` → Portal协议认证成功
2. 等待2秒让网络建立
3. 调用 `chkstatus` 检查 → `result:1` 才算真正在线
4. 最多等待20秒（10次 × 2秒），如仍未在线则重新登录

## 12. 注意事项

1. 页面编码使用 GB2312，需注意中文处理
2. 大部分接口使用JSONP跨域请求
3. IP地址可能需要Base64编码或转十进制
4. MAC地址需要去除分隔符并转大写
5. 支持别名认证 (`enable_alias=0`)
6. 缓存过期时间可配置 (`storeExpireTime=86400秒`)
7. **WiFi环境必需提供真实MAC地址和AC信息，否则认证失败**
8. **Portal认证成功后需通过chkstatus验证真实在线状态**
9. **URL中可能有多个同名参数（如wlanacname），取第一个**
10. **SSID参数虽非强制但建议提供，提高认证成功率**

---

**分析时间**: 2025-11-09（更新）  
**系统版本**: Dr.COM Portal 4.0  
**JS版本**: 4.2.1  
**更新内容**: 添加WiFi vs 网线连接差异、AC重定向机制、在线状态验证

